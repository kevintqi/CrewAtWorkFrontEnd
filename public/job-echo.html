<link rel="import" href="bower_components/polymer/polymer-element.html">
<link rel="import" href="shared-styles.html">
<link rel="import" href="bower_components/polymerfire/firebase-messaging.html">
<link rel="import" href="bower_components/polymerfire/polymerfire.html">
<link rel="import" href="bower_components/polymerfire/firebase-app.html">
<link rel="import" href="bower_components/iron-pages/iron-pages.html">

<link rel="import" href="job-intro-echo-display.html">
<link rel="import" href="job-list-echo-display.html">
<link rel="import" href="job-create-echo-display.html">

<dom-module id="job-echo">
  <template>
    <style include="shared-styles">
      :host {
        display: block;
        padding: 10px;
      }
    </style>

    <!-- IMPORTANT: The firebase-app element needs to appear before any
      other firebase-* elements -->
    <firebase-app
      id="firebase"
      auth-domain="crewatworkfrontend.firebaseapp.com"
      api-key="AIzaSyCLsg2gkWT_9b6TcUM5zP7cHPkF2yjYzyc"
      database-url="https://crewatworkfrontend.firebaseio.com"
      project-id="crewatworkfrontend" storage-bucket=""
      messaging-sender-id="419564990758">
    </firebase-app>


    <firebase-messaging id="messaging" token="{{token}}" on-message="_handleMessage">
    </firebase-messaging>

    <iron-pages
      selected="[[page]]"
      attr-for-selected="name"
      fallback-selection="job-intro-echo-display">
          <job-intro-echo-display name="job-intro-echo-display"></job-intro-echo-display>
          <job-list-echo-display name="beca-list-jobs"></job-list-echo-display>
          <job-create-echo-display name="beca-create-job"></job-create-echo-display>
    </iron-pages>

    <div class="card">
      <p>Token:</p>
      <p>[[token]]</p>
    </div>

  </template>

  <script>
    class JobEcho extends Polymer.Element {
      static get is() { return 'job-echo'; }

      static get properties() {
        return {
          page: {
            type: String,
            notify: true,
            value: "job-intro-echo-display"
          }
        }
      }

      ready() {
        super.ready();
        this.$.messaging.requestPermission().then(() => {
          console.log('user subscribed successfully!');
        }, (err) => {
          console.log('user subscribe failed :(', err);
        });
      }
      _handleMessage() {
        console.log(arguments);
        let cmd = arguments[1].message.notification.title;
        this._pageChange(cmd);
        window.dispatchEvent(new CustomEvent('echo-msg', {
          detail: {'cmd': cmd,
          'msg': arguments[1].message.notification.body}}));
      }

      _pageChange(cmd) {
        switch(cmd) {
          case "beca-list-jobs":
          case "beca-create-job":
            this.page = cmd;
          break;
          default:
          break;
        }
      }
    }
      window.customElements.define(JobEcho.is, JobEcho);
    </script>
  </dom-module>