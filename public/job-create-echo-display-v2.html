<link rel="import" href="bower_components/polymer/polymer-element.html">
<link rel="import" href="bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="bower_components/iron-icon/iron-icon.html">
<link rel="import" href="bower_components/iron-icons/iron-icons.html">
<link rel="import" href="bower_components/iron-icons/av-icons.html">
<link rel="import" href="bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="bower_components/paper-input/paper-input.html">
<link rel="import" href="bower_components/paper-button/paper-button.html">
<link rel="import" href="bower_components/polymerfire/firebase-app.html">
<link rel="import" href="bower_components/polymerfire/firebase.html">
<link rel="import" href="bower_components/iron-form/iron-form.html">
<link rel="import" href="shared-styles.html">

<dom-module id="job-create-echo-display">
  <template>
    <style include="shared-styles iron-flex">
      :host {
        display: block;
        padding: 10px;
      }

      paper-spinner.multi {
        --paper-spinner-layer-1-color: var(--paper-purple-500);
        --paper-spinner-layer-2-color: var(--paper-cyan-500);
        --paper-spinner-layer-3-color: var(--paper-blue-grey-500);
        --paper-spinner-layer-4-color: var(--paper-amber-500);
      }

      .state-active {
        visibility: active;
        background: lightskyblue;
      }

      .state-inactive {
        visibility: hidden;
        background: gray;
      }

      .state-processed {
        visibility: visible;
        background: white;
      }

      /* Used for card-done */
      .state-confirmed {
        background:gold;
      }

      /* Used for card-waiting */
      .state-waiting {
        background:orangered;
        color:mintcream;
      }

      /* Used for card-waiting */
      .state-ready {
        background: green;
        color:mintcream;
      }

      iron-label {
        color: black;
        font-weight: bold;
        font-size: x-large;
      }

      paper-button.green {
        background-color: var(--paper-green-500);
        color: white;
      }
      paper-button.green[active] {
        background-color: var(--paper-red-500);
      }
      paper-button.disabled {
        color: white;
      }

    </style>

    <div class="card">
      <div class="circle">Sebeca</div>
      <h3> Welcome to the Beca Echo Display</h3>
      <div class="card state-waiting layout horizontal" id="beca-create-job">
        <iron-icon icon="av:hearing"></iron-icon>
        <paper-spinner class="multi" active id="beca-create-job-spinner"></paper-spinner>
        <label id="label-waiting"><h4>Ready for input create job</h4></label>
      </div>
    </div>


    <iron-form id="form" on-iron-form-response="_handleFormSubmit"
                        on-iron-form-error="_handleError"
                        on-iron-form-presubmit="_presubmit"
                        content-type="application/json">
      <form method="post" content-type="application/json" action="https://4s3eofq8j5.execute-api.us-west-2.amazonaws.com/dev/api/v1/job">

<div id="list">

        <div class="card state-inactive layout horizontal " id="beca-create-job-squad-id">
          <iron-icon icon="icons:record-voice-over" id="beca-create-job-squad-id-icon"></iron-icon>
          <paper-spinner class="multi" active id="beca-create-job-squad-id-spinner"></paper-spinner>
          <paper-input id="beca-create-job-squad-id-input" name="squadId" label="Squad Id" required autocomplete="squadId"></paper-input>
        </div>

        <div class="card state-inactive layout horizontal " id="beca-create-job-contact-name">
          <iron-icon icon="icons:record-voice-over" id="beca-create-job-contact-name-icon"></iron-icon>
          <paper-spinner class="multi" active id="beca-create-job-contact-name-spinner"></paper-spinner>
          <paper-input id="beca-create-job-contact-name-input" name="name" label="Name" required autocomplete="name"></paper-input>
        </div>

        <div class="card state-inactive layout horizontal " id="beca-create-job-contact-phone">
          <iron-icon icon="icons:record-voice-over" id="beca-create-job-contact-phone-icon"></iron-icon>
          <paper-spinner class="multi" active id="beca-create-job-contact-phone-spinner"></paper-spinner>
          <paper-input id="beca-create-job-contact-phone-input" name="phone" label="Phone" required autocomplete="Phone"></paper-input>
        </div>

        <div class="card state-inactive layout horizontal " id="beca-create-job-location-street">
          <iron-icon icon="icons:record-voice-over" id="beca-create-job-location-street-icon"></iron-icon>
          <paper-spinner class="multi" active id="beca-create-job-location-street-spinner"></paper-spinner>
          <paper-input id="beca-create-job-location-street-input" name="street" label="Street" required autocomplete="street"></paper-input>
        </div>

        <div class="card state-inactive layout horizontal " id="beca-create-job-location-city">
          <iron-icon icon="icons:record-voice-over" id="beca-create-job-location-city-icon"></iron-icon>
          <paper-spinner class="multi" active id="beca-create-job-location-city-spinner"></paper-spinner>
          <paper-input id="beca-create-job-location-city-input" name="city" label="City" required autocomplete="city"></paper-input>
        </div>

        <div class="card state-inactive layout horizontal " id="beca-create-job-location-state">
          <iron-icon icon="icons:record-voice-over" id="beca-create-job-location-state-icon"></iron-icon>
          <paper-spinner class="multi" active id="beca-create-job-location-state-spinner"></paper-spinner>
          <paper-input id="beca-create-job-location-state-input" name="state" label="State" required autocomplete="state"></paper-input>
        </div>

        <div class="card state-inactive layout horizontal " id="beca-create-job-location-zipcode">
          <iron-icon icon="icons:record-voice-over" id="beca-create-job-location-zipcode-icon"></iron-icon>
          <paper-spinner class="multi" active id="beca-create-job-location-zipcode-spinner"></paper-spinner>
          <paper-input id="beca-create-job-location-zipcode-input" name="zipCode" label="Zip Code" required autocomplete="zip"></paper-input>
        </div>


        <div class="card state-inactive layout horizontal " id="beca-create-job-schedule-repeat-type">
          <iron-icon icon="icons:record-voice-over" id="beca-create-job-schedule-repeat-type-icon"></iron-icon>
          <paper-spinner class="multi" active id="beca-create-job-schedule-repeat-type-spinner"></paper-spinner>
          <paper-input id="beca-create-job-schedule-repeat-type-input" name="repeatType" label="Repeat Type" required autocomplete="repeat type"></paper-input>
        </div>

        <div class="card state-inactive layout horizontal " id="beca-create-job-schedule-start-date">
          <iron-icon icon="icons:record-voice-over" id="beca-create-job-schedule-start-date-icon"></iron-icon>
          <paper-spinner class="multi" active id="beca-create-job-schedule-start-date-spinner"></paper-spinner>
          <paper-input id="beca-create-job-schedule-start-date-input" name="startDate" label="Start Date" required autocomplete="start date"></paper-input>
        </div>

        <div class="card state-inactive layout horizontal " id="beca-create-job-schedule-end-date">
          <iron-icon icon="icons:record-voice-over" id="beca-create-job-schedule-end-date-icon"></iron-icon>
          <paper-spinner class="multi" active id="beca-create-job-schedule-end-date-spinner"></paper-spinner>
          <paper-input id="beca-create-job-schedule-end-date-input" name="endDate" label="End Date" required autocomplete="end date"></paper-input>
        </div>

        <div class="card state-inactive layout horizontal " id="beca-create-job-schedule-start-time">
          <iron-icon icon="icons:record-voice-over" id="beca-create-job-schedule-start-time-icon"></iron-icon>
          <paper-spinner class="multi" active id="beca-create-job-schedule-start-time-spinner"></paper-spinner>
          <paper-input id="beca-create-job-schedule-start-time-input" name="startTime" label="Start Time" required autocomplete="start time"></paper-input>
        </div>

        <div class="card state-inactive layout horizontal " id="beca-create-job-schedule-end-time">
          <iron-icon icon="icons:record-voice-over" id="beca-create-job-schedule-end-time-icon"></iron-icon>
          <paper-spinner class="multi" active id="beca-create-job-schedule-end-time-spinner"></paper-spinner>
          <paper-input id="beca-create-job-schedule-end-time-input" name="endTime" label="End Time" required autocomplete="end time"></paper-input>
        </div>


        <div class="card state-inactive layout horizontal" id="beca-create-job-done">
          <iron-label> Ready to submit job </iron-label>
          <iron-icon icon="icons:thumb-up"></iron-icon>
          <paper-button class="green" on-tap="_submit">Submit</paper-button>
        </div>

</div>

      </form>
    </iron-form>

  <!-- </div> -->
  <pre>[[response]]</pre>
  <pre>[[errorMsg]]</pre>

</template>

<script>
  class JobCreateEchoDisplay extends Polymer.Element {
    static get is() {
      return 'job-create-echo-display';
    }

    static get properties() {
        return {
          previousItem: {
            type: String,
            notify: true,
            value: ""
          },
          response: {
            type: String,
            value: "none"
          },
          errorMsg: {
            type: String,
            value: "No errors"
          }
        }
      }

    ready() {
      super.ready();
      window.addEventListener('echo-msg', e => { this._handleEcho(e)});
    }

    _handleEcho(e) {
      console.log("_handleEcho: ", e);
      var payload = JSON.parse(e.detail.msg);
      console.log(e.detail.cmd);
      console.log(e.detail.msg);
      this._processCmd(e.detail.cmd, payload.value);
    }

    _processCmd(cmd, value) {
      if (this.previousItem !== "") {
        this.$[this.previousItem + '-spinner'].hidden = true;
        this.$[this.previousItem + '-spinner'].active = false;
        this.$[this.previousItem + '-icon'].icon = "icons:done";
        this.$[this.previousItem].className = 'card state-processed layout horizontal';
      }
      switch (cmd) {
        case "beca-create-job":
          // this.$['label-waiting'].innerHTML = '<h3>' + value + '</h3>';
          this.$[cmd].className = 'card state-ready layout horizontal';
        break;
          case "beca-create-job-squad":
          case "beca-create-job-squad-id":
          case "beca-create-job-contact-name":
          case "beca-create-job-contact-phone":
          case "beca-create-job-location-street":
          case "beca-create-job-location-city":
          case "beca-create-job-location-state":
          case "beca-create-job-location-zipcode":
          case "beca-create-job-schedule-repeat-type":
          case "beca-create-job-schedule-start-date":
          case "beca-create-job-schedule-end-date":
          case "beca-create-job-schedule-start-time":
          case "beca-create-job-schedule-end-time":
            this.$[cmd + '-input'].value = value;
            this.$[cmd + '-spinner'].hidden = false;
            this.$[cmd + '-spinner'].active = true;
            this.$[cmd + '-icon'].icon = "icons:record-voice-over";
            this.$[cmd].className = 'card state-active layout horizontal';
            this.previousItem = cmd;
        break;
          case "beca-create-job-done":
            this.$[cmd].className = 'card state-confirmed layout horizontal';
            this.previousItem = cmd;
          break;
        default:
        console.log("Error: unknown command", cmd);
      }

      // this.$.list.scrollTop = this.$.list.scrollHeight;
      this.$.list.scrollTop = 0;
    }

    _presubmit() {
      let body = this.$.form.request.body;
      let newBody = {
        "squadId": body.squadId,
        "contact": {
          "name": body.name,
          "phoneNumber": body.phone
        },
        "location": {
          "street": body.street,
          "city": body.city,
          "state": body.state,
          "zipCode": body.zipCode
        },
        "schedule": {
          "repeatType": body.repeatType,
          "startDate": body.startDate,
          "endDate": body.endDate,
          "startTime": body.startDate,
          "endTime": body.endDate
        }
      };

      this.$.form.request.body = newBody;
      this.$.form.request.headers = {
        'content-type': 'application/json'
      };
    }

    _submit() {
      this.$.form.submit();
    }

    _handleFormSubmit(e) {
      this.response = JSON.stringify(e.detail.response, '', 2);
    }

    _handleError(e) {
      console.log("form errors: ", e.detail.error);
      this.errorMsg =  e.detail.error;
    }
  }

  window.customElements.define(JobCreateEchoDisplay.is, JobCreateEchoDisplay);
</script>
</dom-module>

//https://stackoverflow.com/questions/23230079/add-a-class-to-polymer-element
//https://www.polymer-project.org/2.0/docs/devguide/events

//https://www.polymer-project.org/2.0/start/toolbox/deploy